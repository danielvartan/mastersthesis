<!-- %:::% .common h1 begin %:::% -->
# Notes
<!-- %:::% .common h1 end %:::% -->

```{r}
#| label: setup
#| include: false

source(here::here("R/_setup.R"))
```

```{r}
#| echo: false
#| output: asis

rutils:::quarto_status(
  type = "polishing",
  of_what = "of this thesis",
  latex_parskip = "\\microskip"
  )
```

## About the data cleaning process

### Pipeline

Like this document, the data cleaning process is 100% reproducible. It can be audit by verifying the code in the `targets` pipeline use (see `./_targets.R`). Learn morea about the `targets` R package [here](https://books.ropensci.org/targets/).

### Lookup tables

Along with the data cleaning procedures, lookup tables were used to clean the text/character variables. These tables were created by manually inspecting the unique values of the raw data and adjusting common misspellings, synonyms, and other issues.

Text/character variables: `track`, `names`, `email`, `country`, `state`, `municiplality`, `postalcode`, `sleep_drugs_which`, `sleep_disorder_which`, `medication_which`.

The lookup tables are available in the research compendium of this thesis. They had to be encrypted because of the sensitive information they contain. If you need access, please contact the author.

The matching of the variables `sleep_drugs_which`, `sleep_disorder_which`, `medication_which` is not complete. This variables were not used in the analysis, but they are available in the research compendium.

## About the geographical information

Geographic data were collected via postal code. When unavailable, the latitude and longitude of the reported city were used.

The unique values of those data (i.e, variables `country`, `state`, `municipality`, `postalcode`) were manually inspected and adjusted using lookup tables. This was a hard task involving crossing information from different sources, such as the [ViaCEP](https://viacep.com.br/) and [OpenStreetMap](https://www.openstreetmap.org/) databases and the [Correios](https://www.correios.com.br/enviar/precisa-de-ajuda/tudo-sobre-cep) postal code documentation.

### Postal codes

After removing all non-numeric characters form the brazillian postal codes (Código de Endereçamento Postal ([CEP](https://pt.wikipedia.org/wiki/C%C3%B3digo_de_Endere%C3%A7amento_Postal))), they were processed by the following rules:

- If they had 9 or more digits, they were truncated to 8 digits (the first 8 digits are the postal code).
- If they between 5 and 7 digits, they were complemented with `0`s at the ending.
- If they had less than 5 digits, they were discarded.

In addition, a visual inspection was performed to check for inconsistencies.

After this process, the postal codes were matched with the [ViaCEP](https://viacep.com.br/) database to check if they exist. Existing postal codes were than validated by the following rules:

- If the postal code had not been modified, it was considered valid.
- If the postal code had been modified, and the state and municipality were the same as the original postal code, it was considered valid.
- Else, it was considered invalid. Invalid CEPs were descarted in the processed dataset.

The final result can be seen in the lookup table files.

The `state` and `municipality` variables were adjusted using the data from the valid postal codes.

## Latitudes and longitudes

The latitude and longitude of the cities were obtained using the [OpenStreetMap](https://www.openstreetmap.org/) database via the [`tidygeocoder`](https://jessecambon.github.io/tidygeocoder/) R package.

The latitudes and longitudes values were extracted considering only the `municiplaity` and `postal_code` variables. The `state` and `country` variables were not used in the process.
